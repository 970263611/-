<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>登录</title>
<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
<style>  
	@media screen and (min-width: 768px){
           
  	}
  	@media screen and (max-width: 768px){
         
  	}
	body
	{
		overflow:hidden;
	}
	.Input
	{
		-webkit-box-flex: 1;
		-ms-flex: 1;
		flex: 1;
		padding: 0;
		overflow: hidden;
		font-family: inherit;
		font-size: inherit;
		font-weight: inherit;
		background: transparent;
		border: none;
		outline: none;
		resize: none;
		color: #1a1a1a;
		height: 48px;
		line-height: 24px;
		display:inline-block;
		width:70%;
		height: 60px;
		vertical-align: middle;
		font-size:20px;
	}
	.hr{ height:1px;border:none;border-top:1px solid #00000040;margin:0;}
	.logoWord
	{
		font-family:logoFont;
		font-size: 60px;
	}
		/*使用前必须先定义*/
	@font-face 
	{
		/* 字体名称随意起 */
		font-family: logoFont;
		/*你下载字体所在的位置*/
		src: url('bb3127/Zentenar-Zierbuchstaben.ttf');
	}
	.btn-primary 
	{
		background-color: #337ab700;
		border-color: #00000040;
	}
	.btn-primary:hover 
	{
		background-color: #f5f5f500;
		border-color: #f5f5f500;
	}
	.btn-primary:focus, .btn-primary.focus 
	{
		background-color: #f5f5f500;
		border-color: #f5f5f500;
	}
	.btn-primary:active, .btn-primary.active, .open > .dropdown-toggle.btn-primary 
	{
		background-color: #f5f5f500;
		border-color: #f5f5f500;
	}
	.btn-primary:active:hover, .btn-primary.active:hover, .open > .dropdown-toggle.btn-primary:hover, .btn-primary:active:focus, .btn-primary.active:focus, .open > .dropdown-toggle.btn-primary:focus, .btn-primary:active.focus, .btn-primary.active.focus, .open > .dropdown-toggle.btn-primary.focus 
	{
		background-color: #f5f5f500;
		border-color: #f5f5f500;
	}
	a 
	{
		color: #00000087;
	}
	.register
	{
		width:100%;
	}
	#mesdiv
	{
		margin:50px;
		margin-top:23px
	}
	#loginBtn
	{
		width:60%;
		margin-top:65px;
		outline: auto;
		color:#00000040;
	}
	#gologin
	{
		margin-top: 15px;
		float:right;
		display: inline-block;
	}
	#formDiv
	{
		height: 60px;
	}
	@media screen and (max-width: 768px){
		#formDiv
		{
			height: 76px;
		}
         #mesdiv
		{
			margin:100px;
			margin-top:23px
		}
		#loginBtn
		{
			width:50%;
		}
		#gologin
		{
			margin-top: -16px;
			margin-right: -50px;
		}
  	}
</style>
</head>
<body>
<div style="background-image:url(images/new/back.jpg);position: absolute;bottom: 0;top: 0;left: 0;right: 0;background-size: cover;z-index:1;">
</div>
<div style="background-color:#ffffff00;z-index:2;position: absolute;left: 50%;margin-left: -225px;top: 10%;" id='mes'>
	<div style='margin-top: 33px;text-align: center;'><span class='logoWord'>dahua</span></div>
	<div id='mesdiv'>
		<div id='formDiv'>
			<span style='vertical-align: middle;margin-left:10px;font-size: 20px;'>用户名：</span>
			<input type='text' id='username1' name='username' class='Input' onkeydown='key_login()'>
		</div>
		<hr class='hr'/>
		<div id='formDiv'>
			<span style='vertical-align: middle;margin-left:8px;font-size: 20px;'>密&nbsp&nbsp&nbsp&nbsp码：</span>
			<input type='password' id='password1' name='password' class='Input' onkeydown='key_login()'>
		</div>
		<hr class='hr'/>
		<div>
			<button class='btn btn-primary' style='width:100%;margin-top:80px;outline: auto;color: white;border-color: black;' onclick='userlogin()'>登录</button>
		</div>
		<div style='margin-top:50px;float:right;'>
			<a style='margin-right:10px;' href='index'>返回首页</a>
			<a onclick='toRegister()' style='cursor:pointer;margin-right:10px;'>去注册</a>
			<a onclick='saoyisao()' style='cursor:pointer;' title=‘登录微信公众号体验扫一扫功能，过期时间三分钟’>扫码登录</a>
		</div>
	</div>
</div>
<script type="text/javascript" src="js/jquery-3.3.1.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script type="text/javascript" src="js/sockjs.js"></script>
<script type="text/javascript" src="layer/layer.js"></script>
<script type="text/javascript">

	console.log("------欢迎访问大花博客,请联系我。邮箱:love_dingwq@163.com。------\n查看简历请访问www.loveding.top/mine");
	
	function toRegister(){
		$('#mesdiv').empty();
		var html = "";
		html += "<div style='height: 60px;'>"+
					"<input type='text' id='nickname' name='nickname' class='Input register' placeholder='注册昵称'>"+
				"</div>"+
				"<hr class='hr'/>"+
				"<div style='height: 60px;'>"+
				"	<input type='text' id='username' name='username' class='Input register' placeholder='注册帐号'>"+
				"</div>"+
				"<hr class='hr'/>"+
				"<div style='height: 60px;'>"+
				"	<input type='password' id='password' name='password' class='Input register' placeholder='注册密碼'>"+
				"</div>"+
				"<hr class='hr'/>"+
				"<div style='height: 60px;'>"+
				"	<input type='password' id='password_once' class='Input register' placeholder='重复密碼'>"+
				"</div>"+
				"<hr class='hr'/>"+
				"<div style='height: 60px;'>"+
				"	<input type='text' id='realname' name='realname' class='Input register' placeholder='真实姓名'>"+
				"</div>"+
				"<hr class='hr'/>"+
				"<div>"+
				"	<button class='btn btn-primary' onclick='userAdd()' id='loginBtn' style='color: white;border-color: black;'>注册</button>"+
				"</div>"+
				"<div id='gologin'>"+
				"	<a style='margin-right:10px;' href='index'>返回首页</a>"+
				"	<a onclick='goToLogin()' style='cursor:pointer;margin-right:10px;'>去登录</a>"+
				"<a onclick='saoyisao()' style='cursor:pointer;' title=‘登录微信公众号体验扫一扫功能，过期时间三分钟’>扫码登录</a>"+
				"<div>";
		$('#mesdiv').append(html);
	}
	
	function goToLogin(){
		$('#mesdiv').empty();
		var html = "<div id='formDiv'>"+
						"<span style='vertical-align: middle;margin-left:10px;font-size: 20px;'>用户名：</span>"+
						"<input type='text' id='username1' name='username' class='Input' onkeydown='key_login()'>"+
					"</div>"+
					"<hr class='hr'/>"+
					"<div id='formDiv'>"+
						"<span style='vertical-align: middle;margin-left:8px;font-size: 20px;'>密&nbsp&nbsp&nbsp&nbsp码：</span>"+
						"<input type='password' id='password1' name='password' class='Input' onkeydown='key_login()'>"+
					"</div>"+
					"<hr class='hr'/>"+
					"<div>"+
						"<button class='btn btn-primary' style='width:100%;margin-top:80px;outline: auto;color: white;border-color: black;'>登录</button>"+
					"</div>"+
					"<div style='margin-top:50px;float:right;'>"+
						"<a style='margin-right:10px;' href='index'>返回首页</a>"+
						"<a onclick='toRegister()' style='cursor:pointer;margin-right:10px;'>去注册</a>"+
						"<a onclick='saoyisao()' style='cursor:pointer;' title=‘登录微信公众号体验扫一扫功能，过期时间三分钟’>扫码登录</a>"+
					"<div>";
		$('#mesdiv').append(html);
	}
	
	function userlogin(){
		var username = $("#username1").val().trim();
		var password = $("#password1").val().trim();
		$.ajax({
			type : "post",
			url : "/login",
			data : {'username':username,'password':password},
			cache: false,
			async: false,
			error: function(request) {
				layer.msg('登陆失败', function(){});
            },
            success: function(data) {
                if(data == "error"){
                	layer.msg('用户名或密码输入错误', function(){});
                }else if(data == "success"){
                	window.location.href = 'index';
                }
            }
		});
	}
	
	function key_login(){
		if(event.keyCode==13){
			userlogin();
		}
	}

	function userAdd(){
		var nickname = $("#nickname").val().trim();
		var username = $("#username").val().trim();
		var password = $("#password").val().trim();
		var realname = $("#realname").val().trim();
		if(nickname=="" || nickname==null || username=="" || username==null || password=="" || password==null || password_once=="" || password_once==null || realname=="" || realname==null){
			layer.msg('请全部填写后提交', function(){});
				return false;
		}
		 if($("#password_once").val() != $("#password").val()){
			 layer.msg('两次密码输入不一致', function(){});
					return false;
		 }
		 if(username.length<6){
			 layer.msg('用户名输入过短，请重新填写密码', function(){});
					return false;
		 }
		 if(password.length<6){
			 layer.msg('密码输入过短，请重新填写密码', function(){});
					return false;
		 }
		$.ajax({
			type : "post",
			url : "/userAdd",
			data : {'nickname':nickname,'username':username,'password':password,'realname':realname},
			cache: false,
			async: false,
			error: function(request) {
				layer.msg('注册失败');
            },
            success: function(data) {
                if(data == "error"){
                	layer.msg('注册失败', function(){});
                }else if(data == "success"){
                	layer.msg('注册成功,正在为您跳转')
               		window.location.href = "/index";
                }else if(data == "NickNamealReguster"){
                	layer.msg('昵称注册重复', function(){});
                		return false;
                }else if(data == "alReguster"){
                	layer.msg('用户名注册重复', function(){});
            		return false;
            }
            }
		});
	}
	
	//扫一扫
	function saoyisao(){
		$('#mesdiv').empty();
		var html = "<div><img id='shareImg' style='width: 300px;'></div>"+
					"<div style='margin-top:50px;float:right;'>"+
						"<a style='margin-right:10px;' href='index'>返回首页</a>"+
						"<a onclick='goToLogin()' style='cursor:pointer;margin-right:10px;'>去登录</a>"+
						"<a onclick='saoyisao()' style='cursor:pointer;' title=‘登录微信公众号体验扫一扫功能，过期时间三分钟’>扫码登录</a>"+
					"<div>";
		$('#mesdiv').append(html);
		erweima();
		send();
	}
	var loginUUID;
	//获取二维码
	function erweima(){
		var guid = getGuid();
		$.ajax({
			type : "post",
			url : "/shareArticle",
			cache: false,
			async: false,
			data: {"id":guid+"*erweimadenglu*"},
			error: function(request) {
				layer.msg('获取二维码失败', function(){});
	        },
	        success: function(data) {
	        	loginUUID = guid;
	        	$('#shareImg').attr("src","http://www.loveding.top:8089/erweima/"+data+".jpg");
	        }
		});
	}
	
	function getGuid() {
	    function S4() {
	       return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
	    }
	    return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
	}
	
	var websocket = null;
    if ('WebSocket' in window) {
        //websocket = new WebSocket("ws://localhost:8080/websocket/socketServer");
    	websocket = new WebSocket("ws://101.132.136.190:8080/websocket/socketServer");
    }else {
        websocket = new SockJS("http://101.132.136.190:8080/sockjs/socketServer");
    }
    
  //连接发生错误的回调方法
    websocket.onerror = function(){
        setMessageInnerHTML("error");
    };

    //连接成功建立的回调方法
    websocket.onopen = function(event){
        setMessageInnerHTML("open");
    }

    //接收到消息的回调方法
    websocket.onmessage = function(event){
        //setMessageInnerHTML(event.data);
		if(event.data==''){
			return;//第一遍握手时候返回空
		}else{
			resultJson = JSON.parse(event.data); 
		}
		if(resultJson.state=='success'){
        	layer.msg('登录成功,正在为您跳转')
        	$.ajax({
    			type : "post",
    			url : "/login",
    			data : {'user':resultJson.user},
    			cache: false,
    			async: false,
    			error: function(request) {
    				layer.msg('登陆失败', function(){});
                },
                success: function(data) {
                    if(data == "error"){
                    	layer.msg('未找到用户', function(){});
                    }else if(data == "success"){
                    	window.location.href = 'index';
                    }
                }
    		});
        }else if(resultJson.state=='timeout'){
        	layer.msg('登录超时', function(){});
        }else if(resultJson.state=='error'){
        	layer.msg('未知错误', function(){});
        }else{
        	layer.msg('未知错误', function(){});
        }
    }

    //连接关闭的回调方法
    websocket.onclose = function(){
        setMessageInnerHTML("close");
    }

    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function(){
        websocket.close();
    }

    //将消息显示在网页上
    function setMessageInnerHTML(innerHTML){
    }

    //关闭连接
    function closeWebSocket(){
        websocket.close();
    }

    //发送消息
    function send(){
        websocket.send(loginUUID);
    }
	
	/* //向后台长轮询消息    这里打算用websocket来实现了
	function longPolling(){
		$.ajax({
			async : true,//异步
			url : 'checkLogin',
			type : 'post',
			data : {'loginUUID':loginUUID},
			dataType : 'json',
			timeout : 30000,//超时时间设定30秒
			error : function(xhr, textStatus, thrownError) {
				return false;//发生异常错误后终止
			},
			success : function(data) {
				if(data=='index'){
					window.location.href = '/index';
				}else if(data=='wait'){
					longPolling();
				}else{
					return false;
				}
			}
		});
	} */
</script>
</body>
</html>